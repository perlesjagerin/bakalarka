@startuml
title Diagram tříd - Backend architektura

skinparam packageStyle rectangle
skinparam linetype polyline
skinparam class {
    BackgroundColor LightBlue
    BorderColor DarkBlue
    ArrowColor Black
}
skinparam defaultFontSize 13
skinparam classAttributeIconSize 0
skinparam nodesep 40
skinparam ranksep 50

' Striktní vertikální layout
top to bottom direction

package "Controllers" {
  AuthController -[hidden]down- EventController
  EventController -[hidden]down- ReservationController
  ReservationController -[hidden]down- PaymentController
  PaymentController -[hidden]down- ComplaintController
  
  class AuthController {
    + register()
    + login()
    + refresh()
    + logout()
  }
  
  class EventController {
    + getAllEvents()
    + getEventById()
    + createEvent()
    + updateEvent()
    + deleteEvent()
  }
  
  class ReservationController {
    + createReservation()
    + getUserReservations()
    + cancelReservation()
    + downloadTicket()
  }
  
  class PaymentController {
    + createPaymentIntent()
    + handleStripeWebhook()
    + refundPayment()
  }
  
  class ComplaintController {
    + createComplaint()
    + getUserComplaints()
    + updateComplaintStatus()
  }
}

package "Services" {
  AuthService -[hidden]down- EventService
  EventService -[hidden]down- ReservationService
  ReservationService -[hidden]down- PaymentService
  PaymentService -[hidden]down- ComplaintService
  ComplaintService -[hidden]down- EmailService
  EmailService -[hidden]down- TicketGenerator
  
  class AuthService {
    + registerUser()
    + loginUser()
    + refreshAccessToken()
    + logout()
  }
  
  class EventService {
    + getAllEvents()
    + getEventById()
    + createEvent()
    + updateEvent()
    + deleteEvent()
  }
  
  class ReservationService {
    + createReservation()
    + getUserReservations()
    + cancelReservation()
  }
  
  class PaymentService {
    + createPaymentIntent()
    + handleWebhook()
    + processRefund()
  }
  
  class ComplaintService {
    + createComplaint()
    + getUserComplaints()
    + updateStatus()
    + resolveComplaint()
  }
  
  class EmailService {
    + sendEmail()
    + sendReservationConfirmation()
    + sendPaymentConfirmation()
  }
  
  class TicketGenerator {
    + generateTicketPDF()
  }
}

package "Middleware" {
  AuthMiddleware -[hidden]down- ValidationMiddleware
  ValidationMiddleware -[hidden]down- ErrorMiddleware
  
  class AuthMiddleware {
    + authenticate()
    + authorizeRole()
  }
  
  class ValidationMiddleware {
    + validateRequest()
  }
  
  class ErrorMiddleware {
    + handleError()
  }
}

package "Database" {
  class PrismaClient {
    + user: UserDelegate
    + event: EventDelegate
    + reservation: ReservationDelegate
    + payment: PaymentDelegate
    + complaint: ComplaintDelegate
  }
}

' Vynucení pořadí balíčků
ComplaintController -[hidden]down- AuthService
TicketGenerator -[hidden]down- AuthMiddleware
ErrorMiddleware -[hidden]down- PrismaClient

' Controller -> Service vztahy (vertikální směr)
AuthController -down-> AuthService
EventController -down-> EventService
ReservationController -down-> ReservationService
PaymentController -down-> PaymentService
ComplaintController -down-> ComplaintService

' Service -> Database vztahy (vertikální směr)
AuthService -down-> PrismaClient
EventService -down-> PrismaClient
ReservationService -down-> PrismaClient
PaymentService -down-> PrismaClient
ComplaintService -down-> PrismaClient

' Service -> Service vztahy
ReservationService -down-> EmailService
PaymentService -down-> EmailService
ReservationService -down-> TicketGenerator

' Externí API
PaymentService -down-> "Stripe API" : uses

@enduml
